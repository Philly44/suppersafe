<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Your Waitlist Status - SupperSafe</title>
  <meta name="description" content="Check your waitlist position and share to move up.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #FAF9F7;
      min-height: 100vh;
      color: #1a1a1a;
    }

    .header {
      background: white;
      border-bottom: 1px solid #E8E4DD;
      padding: 16px 20px;
    }

    .header-inner {
      max-width: 500px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: inherit;
    }

    .logo-mark {
      width: 22px;
      height: 22px;
      border: 2px solid #1a1a1a;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-mark-inner {
      width: 6px;
      height: 6px;
      background: #2D5A3D;
      border-radius: 50%;
    }

    .logo-text {
      font-size: 16px;
      font-weight: 500;
    }

    .tag {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      padding: 5px 10px;
      border-radius: 4px;
      background: #ECFDF5;
      color: #059669;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    .not-signed-up {
      text-align: center;
      padding: 60px 20px;
    }

    .not-signed-up h1 {
      font-size: 24px;
      margin-bottom: 12px;
    }

    .not-signed-up p {
      color: #6B665C;
      margin-bottom: 24px;
    }

    .btn-primary {
      display: inline-block;
      background: #F97316;
      color: white;
      padding: 14px 28px;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      transition: background 0.2s ease;
    }

    .btn-primary:hover {
      background: #EA580C;
    }

    .lookup-section {
      margin-top: 40px;
      padding-top: 32px;
      border-top: 1px solid #E8E4DD;
    }

    .lookup-divider {
      font-size: 13px;
      color: #A09A8F;
      margin-bottom: 16px;
    }

    .lookup-form {
      display: flex;
      gap: 8px;
      max-width: 320px;
      margin: 0 auto;
    }

    .lookup-input {
      flex: 1;
      padding: 12px 14px;
      font-size: 14px;
      border: 1.5px solid #D4D0C8;
      border-radius: 8px;
      background: white;
      font-family: inherit;
    }

    .lookup-input:focus {
      outline: none;
      border-color: #2D5A3D;
    }

    .lookup-btn {
      padding: 12px 18px;
      background: #2D5A3D;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s ease;
    }

    .lookup-btn:hover {
      background: #234A31;
    }

    .lookup-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .lookup-error {
      font-size: 13px;
      color: #DC2626;
      margin-top: 12px;
      min-height: 20px;
    }

    .dashboard {
      display: none;
    }

    .dashboard.active {
      display: block;
    }

    .position-card {
      background: linear-gradient(135deg, #1a1a1a 0%, #2D5A3D 100%);
      border-radius: 16px;
      padding: 28px;
      color: white;
      text-align: center;
      margin-bottom: 20px;
    }

    .position-label {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 8px;
    }

    .position-number {
      font-size: 56px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 8px;
    }

    .position-message {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border: 1px solid #E8E4DD;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #2D5A3D;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: #6B665C;
    }

    .referral-card {
      background: white;
      border: 1px solid #E8E4DD;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .referral-card h2 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .referral-card > p {
      font-size: 14px;
      color: #6B665C;
      margin-bottom: 16px;
    }

    .referral-card strong {
      color: #F97316;
    }

    .referral-code-wrapper {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .referral-code-input {
      flex: 1;
      padding: 12px 14px;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-align: center;
      border: 1.5px solid #D4D0C8;
      border-radius: 8px;
      background: #FAF9F7;
    }

    .copy-btn {
      padding: 12px 18px;
      background: #2D5A3D;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .copy-btn:hover {
      background: #234A31;
    }

    .copy-btn.copied {
      background: #059669;
    }

    .share-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .share-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: opacity 0.2s ease;
    }

    .share-btn:hover {
      opacity: 0.9;
    }

    .share-btn svg {
      width: 18px;
      height: 18px;
    }

    .share-btn.twitter {
      background: #1DA1F2;
      color: white;
    }

    .share-btn.whatsapp {
      background: #25D366;
      color: white;
    }

    .share-btn.link {
      background: #FAF9F7;
      color: #4A4640;
      border: 1px solid #E8E4DD;
    }

    .countdown-card {
      background: white;
      border: 1px solid #E8E4DD;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }

    .countdown-label {
      font-size: 12px;
      color: #6B665C;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
    }

    .countdown-timer {
      display: flex;
      justify-content: center;
      gap: 16px;
    }

    .countdown-unit {
      text-align: center;
    }

    .countdown-value {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
    }

    .countdown-unit-label {
      font-size: 10px;
      color: #A09A8F;
      text-transform: uppercase;
    }

    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #1a1a1a;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.visible {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    @media (max-width: 400px) {
      .share-buttons {
        grid-template-columns: 1fr;
      }

      .referral-code-wrapper {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <a href="index.html" class="logo">
      <div class="logo-mark">
        <div class="logo-mark-inner"></div>
      </div>
      <span class="logo-text">suppersafe</span>
    </a>
    <span class="tag" id="statusTag">You're In</span>
  </div>
</header>

<div class="container">
  <div class="not-signed-up" id="notSignedUp">
    <h1>Join the Waitlist</h1>
    <p>You haven't signed up yet. Join now to get early access.</p>
    <a href="index.html" class="btn-primary">Sign Up Now</a>

    <div class="lookup-section">
      <p class="lookup-divider">Already signed up?</p>
      <div class="lookup-form">
        <input type="email" class="lookup-input" id="lookupEmail" placeholder="Enter your email">
        <button class="lookup-btn" id="lookupBtn">Find My Spot</button>
      </div>
      <p class="lookup-error" id="lookupError"></p>
    </div>
  </div>

  <div class="dashboard" id="dashboard">
    <div class="position-card">
      <div class="position-label">Your Position</div>
      <div class="position-number" id="positionNumber">#248</div>
      <div class="position-message" id="positionMessage">Share to jump ahead!</div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="friendsReferred">0</div>
        <div class="stat-label">Friends Referred</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="spotsJumped">0</div>
        <div class="stat-label">Spots Jumped</div>
      </div>
    </div>

    <div class="referral-card">
      <h2>Move Up the List</h2>
      <p>Each friend who signs up = <strong>+10 spots</strong>. Share your code:</p>

      <div class="referral-code-wrapper">
        <input type="text" class="referral-code-input" id="referralCode" readonly value="SUPPER-XXXX">
        <button class="copy-btn" id="copyCodeBtn">Copy</button>
      </div>

      <div class="share-buttons">
        <button class="share-btn twitter" id="shareTwitter">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
          Twitter
        </button>
        <button class="share-btn whatsapp" id="shareWhatsapp">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
          WhatsApp
        </button>
        <button class="share-btn link" id="shareLink">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
          Copy Link
        </button>
      </div>
    </div>

    <div class="countdown-card">
      <div class="countdown-label">Launching January 1, 2026</div>
      <div class="countdown-timer">
        <div class="countdown-unit">
          <div class="countdown-value" id="countdownDays">00</div>
          <div class="countdown-unit-label">Days</div>
        </div>
        <div class="countdown-unit">
          <div class="countdown-value" id="countdownHours">00</div>
          <div class="countdown-unit-label">Hours</div>
        </div>
        <div class="countdown-unit">
          <div class="countdown-value" id="countdownMinutes">00</div>
          <div class="countdown-unit-label">Min</div>
        </div>
        <div class="countdown-unit">
          <div class="countdown-value" id="countdownSeconds">00</div>
          <div class="countdown-unit-label">Sec</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">Copied!</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://txxkimndpqprbqhlknrk.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4eGtpbW5kcHFwcmJxaGxrbnJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxOTE1ODgsImV4cCI6MjA3OTc2NzU4OH0.4Zm1ShwG-_kc_E0tkltEBnNzfWdVeb7gRDh6b3-pCb8';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const toast = document.getElementById('toast');

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add('visible');
    setTimeout(() => toast.classList.remove('visible'), 2500);
  }

  // Show dashboard with user data
  function showDashboard(code, position) {
    document.getElementById('notSignedUp').style.display = 'none';
    document.getElementById('dashboard').classList.add('active');

    // Set referral code
    document.getElementById('referralCode').value = code;

    // Set position
    document.getElementById('positionNumber').textContent = `#${position}`;

    // Position message
    const posNum = parseInt(position);
    if (posNum <= 500) {
      document.getElementById('positionMessage').textContent = 'You\'re a founding member!';
    } else {
      document.getElementById('positionMessage').textContent = 'Share to move into the founding 500!';
    }

    // Store in localStorage for future visits
    localStorage.setItem('suppersafe_unlocked', 'true');
    localStorage.setItem('suppersafe_referral_code', code);
    localStorage.setItem('suppersafe_queue_position', position);
  }

  // Check URL for code param (bookmarked link)
  const urlParams = new URLSearchParams(window.location.search);
  const codeFromUrl = urlParams.get('code');

  // Check localStorage
  const isSignedUp = localStorage.getItem('suppersafe_unlocked') === 'true';
  const referralCode = localStorage.getItem('suppersafe_referral_code');
  const queuePosition = localStorage.getItem('suppersafe_queue_position');

  // Priority: URL code > localStorage
  if (codeFromUrl) {
    // Validate code format and show dashboard
    if (/^SUPPER-[A-Z0-9]{4}$/.test(codeFromUrl)) {
      // For now, use code from URL with estimated position
      // In production, this would query Supabase for actual position
      const estimatedPosition = queuePosition || '248';
      showDashboard(codeFromUrl, estimatedPosition);
    }
  } else if (isSignedUp && referralCode) {
    showDashboard(referralCode, queuePosition || '248');
  }

  // Email lookup handler
  document.getElementById('lookupBtn').addEventListener('click', async () => {
    const email = document.getElementById('lookupEmail').value.trim().toLowerCase();
    const errorEl = document.getElementById('lookupError');
    const btn = document.getElementById('lookupBtn');

    errorEl.textContent = '';

    if (!email) {
      errorEl.textContent = 'Please enter your email';
      return;
    }

    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      errorEl.textContent = 'Please enter a valid email';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Looking up...';

    try {
      // Query via Edge Function (secure - uses service role)
      const response = await fetch(`${SUPABASE_URL}/functions/v1/waitlist-lookup`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({ email })
      });

      const data = await response.json();

      if (!response.ok) {
        errorEl.textContent = data.error || 'Email not found. Have you signed up?';
        btn.disabled = false;
        btn.textContent = 'Find My Spot';
        return;
      }

      // Found! Show dashboard
      showDashboard(data.referral_code, data.queue_position);

      // Update URL for bookmarking
      const newUrl = `${window.location.pathname}?code=${data.referral_code}`;
      window.history.replaceState({}, '', newUrl);

    } catch (err) {
      console.warn('Email lookup error:', err);
      errorEl.textContent = 'Lookup not available. Try the same browser you signed up on.';
      btn.disabled = false;
      btn.textContent = 'Find My Spot';
    }
  });

  // Allow Enter key to submit
  document.getElementById('lookupEmail').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('lookupBtn').click();
    }
  });

  // Countdown
  const launchDate = new Date('2026-01-01T00:00:00-05:00');

  function updateCountdown() {
    const now = new Date();
    const diff = launchDate - now;

    if (diff <= 0) return;

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

    document.getElementById('countdownDays').textContent = days.toString().padStart(2, '0');
    document.getElementById('countdownHours').textContent = hours.toString().padStart(2, '0');
    document.getElementById('countdownMinutes').textContent = minutes.toString().padStart(2, '0');
    document.getElementById('countdownSeconds').textContent = seconds.toString().padStart(2, '0');
  }

  updateCountdown();
  setInterval(updateCountdown, 1000);

  // Copy code
  document.getElementById('copyCodeBtn').addEventListener('click', async () => {
    const code = document.getElementById('referralCode').value;
    await navigator.clipboard.writeText(code);
    const btn = document.getElementById('copyCodeBtn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    showToast('Code copied!');
    setTimeout(() => {
      btn.textContent = 'Copy';
      btn.classList.remove('copied');
    }, 2000);
  });

  // Share buttons - read from localStorage at click time (may have been updated by showDashboard)
  document.getElementById('shareTwitter').addEventListener('click', () => {
    const code = localStorage.getItem('suppersafe_referral_code') || 'SUPPER';
    const position = localStorage.getItem('suppersafe_queue_position') || '248';
    const text = `I'm #${position} on the SupperSafe waitlist!\n\nGet real-time alerts when Toronto restaurants fail health inspections.\n\nUse my code ${code} to jump ahead:\nsuppersafe.com?ref=${code}`;
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
  });

  document.getElementById('shareWhatsapp').addEventListener('click', () => {
    const code = localStorage.getItem('suppersafe_referral_code') || 'SUPPER';
    const text = `Hey! I signed up for SupperSafe - it alerts you when Toronto restaurants fail health inspections.\n\nUse my code to jump the line: ${code}\nsuppersafe.com?ref=${code}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
  });

  document.getElementById('shareLink').addEventListener('click', async () => {
    const code = localStorage.getItem('suppersafe_referral_code') || 'SUPPER';
    const link = `https://suppersafe.com?ref=${code}`;
    await navigator.clipboard.writeText(link);
    showToast('Link copied!');
  });
</script>

</body>
</html>
